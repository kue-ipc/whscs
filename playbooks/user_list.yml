- name: User list
  hosts: localhost
  tasks:
    - name: Task webusers in user role
      ansible.builtin.import_role:
        name: user
        tasks_from: webusers

    - name: Debug user_webuser_list var
      ansible.builtin.debug:
        var: user_webuser_list

    - name: Debug need sync users
      ansible.builtin.debug:
        msg: >-
          {{ {
            "present": user_webuser_list | difference(user_existing_list),
            "absent": user_existing_list | difference(user_webuser_list),
          } }}

    - name: Set export names
      ansible.builtin.set_fact:
        export_names:
          - name
          - site
          - uid
          - host
          - enabled
          - public
          - acme
          - app_use
          - db_use
          - pg_use

    # - name: Debug user_webusers var
    #   ansible.builtin.debug:
    #     msg: '{{ user_webusers | ansible.utils.keep_keys(target=export_names) }}'

    - name: Create YAML
      delegate_to: localhost
      ansible.builtin.copy:
        dest: '{{ data_dir }}/webusers.yml'
        content: |
          {{ user_webusers | ansible.utils.keep_keys(target=export_names) | to_nice_yaml }}
        mode: '0644'

    - name: Create CSV
      delegate_to: localhost
      ansible.builtin.copy:
        dest: '{{ data_dir }}/webusers.csv'
        content: |
          {{ export_names | join(",") }}
          {% for user, info in user_webusers.items() %}
          {{ export_names | map("extract", info) | join(",") }}
          {% endfor %}
        mode: '0644'
